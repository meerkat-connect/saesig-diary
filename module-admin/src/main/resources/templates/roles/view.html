<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorate="~{layout/main}">

<div layout:fragment="content" class="page-body">
    <div class="page-body">
        <div class="nav-main">
            <ul class="nav nav-tabs md-tabs" role="tablist">
                <li class="nav-item">
                    <a class="nav-link active" data-bs-toggle="tab" href="#home3" role="tab" aria-selected="false">역할 등록</a>
                    <div class="slide"></div>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#profile3" role="tab" aria-selected="false">사용자 매핑</a>
                    <div class="slide"></div>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-bs-toggle="tab" href="#messages3" role="tab" aria-selected="true">자원 매핑</a>
                    <div class="slide"></div>
                </li>
            </ul>
        </div>
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-block-small">
                        <div class="tab-content tabs p-t-20">
                            <div class="tab-pane active" id="home3" role="tabpanel">
                                <div class="col-12">
                                    <div class="tab-content tabs">
                                        <div class="tab-pane active" id="roleJudge" role="tabpanel">
                                            <div class="row">
                                                <div class="col-12 col-xl-4">
                                                    <h5 class="mb-3">
                                                        <strong>역할구조</strong>
                                                    </h5>
                                                    <div class="card">
                                                        <div class="card-block-small tree-view">
                                                            <div id="jstree"></div>
                                                        </div>
                                                    </div>
                                                </div>

                                                <div class="col-12 col-xl-8">
                                                    <h5 class="mb-3">
                                                        <strong>역할 상세정보</strong>
                                                    </h5>
                                                    <form id="roleForm" name="roleForm">
                                                        <input type="hidden" name="id" id="id"/>

                                                        <div class="card">
                                                            <div class="card-block-small">
                                                                <div class="mb-3 form-group row">
                                                                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="upperId"><strong>상위 역할명</strong></label>
                                                                    <div class="col-sm-12">
                                                                        <input type="text" class="form-control form-control-round" name="upperId" id="upperId" readonly/>
                                                                    </div>
                                                                </div>

                                                                <div class="mb-3 form-group row">
                                                                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="name"><strong>역할명</strong></label>
                                                                    <p class="text-warning m-b-0">* 역할명은 "ROLE_"를 접두사로 가져야합니다.</p>
                                                                    <div class="col-sm-12">
                                                                        <input type="text" class="form-control form-control-round" name="name" id="name"/>
                                                                    </div>
                                                                </div>

                                                                <div class="mb-3 form-group row">
                                                                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="name"><strong>설명</strong></label>
                                                                    <div class="col-sm-12">
                                                                        <input type="text" class="form-control form-control-round" name="description" id="description"/>
                                                                    </div>
                                                                </div>

                                                                <div class="mb-3 form-group row">
                                                                    <label class="form-label col-sm-12 col-form-label p-t-0 pb-1" for="type1"><strong>역할 유형 (관리자 / 사용자) </strong></label>
                                                                    <div class="form-radio">
                                                                        <div class="radio radio-inline">
                                                                            <label class="mb-0">
                                                                                <input type="radio" id="type1" name="type" value="ADMIN" checked>
                                                                                <i class="helper"></i>관리자
                                                                            </label>
                                                                        </div>

                                                                        <div class="radio radio-inline">
                                                                            <label class="mb-0">
                                                                                <input type="radio" id=type2 name="type" value="USER">
                                                                                <i class="helper"></i>사용자
                                                                            </label>
                                                                        </div>
                                                                    </div>
                                                                </div>

                                                                <div class="mb-3 form-group row">
                                                                    <div class="col-sm-12">
                                                                        <input type="checkbox" class="js-single-small" name="isEnabled" id="isEnabled" checked/>
                                                                        <label for="isEnabled" class="v-middle">사용여부</label>
                                                                    </div>
                                                                </div>

                                                                <div class="mb-0 mt-4 form-group row">
                                                                    <div class="col-sm-12">
                                                                        <button type="button" class="btn btn-primary" id="saveBtn">
                                                                            저장
                                                                        </button>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </form>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane" id="profile3" role="tabpanel">
                                <div class="row" id="mappingUserContent"></div>
                            </div>
                            <div class="tab-pane" id="configMenu" role="tabpanel">
                                <div id="configMenuContent"></div>
                            </div>
                            <div class="tab-pane" id="messages3" role="tabpanel">
                                <div id="configInstContent"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <link rel="stylesheet" type="text/css" th:href="@{/files/assets/pages/treeview/treeview.css}"></link>
    <link rel="stylesheet" type="text/css" th:href="@{/files/bower_components/jstree/dist/themes/default/style.css}"></link>
    <script type="text/javascript" src="/files/bower_components/jstree/dist/jstree.js"></script>

    <script th:inline="javascript">
        const roleController = {
            roles: [],
            parentNode: null,
            selectedNode: null,
            $jstree: $('#jstree'),

            init: function () {
                const _this = this;
                parentNode = null;
                selectedNode = null;

                $.ajax({
                    url: '/admin/roles',
                    type: 'get',
                    async: false
                }).done(function (response) {
                    response.forEach(function (element, index) {
                        _this.roles[index] = {
                            id: element.id,
                            parent: element.parentId ? element.parentId : '#',
                            text: element.name,
                            description: element.description,
                            isEnabled: element.isEnabled,
                            name: element.name,
                        };
                    });
                }).fail(function (error) {
                    alert("역할 목록을 조회하는데 실패하였습니다.");
                });

                _this.renderJsTree();
            },

            renderJsTree: function () {
                const _this = this;

                _this.$jstree.jstree({
                    "core": {
                        "animation": 50,
                        "strings": {
                            loading: "Loading ..."
                        },
                        "themes": {
                            "responsive": true,
                        },
                        'data': _this.roles,
                    },
                    "types": {
                        "ADMIN": {
                            "icon": "icofont icofont-folder"
                        },
                        "USER": {
                            "icon": "icofont icofont-file-alt"
                        }
                    },
                    'contextmenu': {
                        'items': {
                            "regist": {
                                "separator_before": false,
                                "separator_after": false,
                                "label": "하위 등록",
                                "action": function (obj) {
                                    $('#roleForm')[0].reset();
                                    $('#id').val('');
                                    $('#type1').prop('checked', true);
                                    $('#upperId').val(_this.selectedNode.original.id);
                                }
                            }
                        }
                    },
                    'plugins': ['types', 'contextmenu']
                }).bind("select_node.jstree", function (event, data) {
                    _this.selectedNode = _this.$jstree.jstree('get_selected', true)[0];
                    _this.parentNode = _this.$jstree.jstree(true).get_node(_this.selectedNode.parent);
                    _this.print();
                });
            },


            save: function () {
                const id = $('#roleForm #id').val();
                !!id ? this.update(id) : this.insert(id);
            },

            update: function () {
                const _this = this;

                if (confirm('역할 정보를 수정하시겠습니까?')) {
                    const formData = $('#roleForm').serializeObject();
                    formData.isEnabled = formData.isEnabled ? "Y" : "N";

                    $.ajax({
                        url: `/admin/roles/${formData.id}`,
                        type: 'put',
                        data: JSON.stringify(formData),
                        contentType: 'application/json'
                    }).done(function (response) {
                        alert('역할이 수정되었습니다.');
                        _this.$jstree.jstree().destroy();
                        _this.init();
                        _this.$jstree.jstree(true)._open_to(_this.selectedNode.id);
                    }).fail(function (error) {
                        alert('역할을 수정하는데 실패하였습니다.')
                        console.log(JSON.stringify(error));
                    })
                }
            },

            insert: function () {
                const _this = this;

                if (confirm('역할 정보를 등록하시겠습니까?')) {
                    const formData = $('#roleForm').serializeObject();
                    formData.depth = this.selectedNode.original.depth + 1;
                    formData.ord = this.selectedNode.children.length + 1;
                    formData.isEnabled = formData.isEnabled ? "Y" : "N";

                    $.ajax({
                        url: '/admin/roles',
                        type: 'post',
                        data: JSON.stringify(formData),
                        contentType: 'application/json'
                    }).done(function () {
                        alert('역할이 등록되었습니다.');
                        _this.$jstree.jstree().destroy();
                        _this.init();
                        _this.$jstree.jstree(true)._open_to(_this.selectedNode.id);
                    }).fail(function (error) {
                        alert('역할을 등록하는데 실패하였습니다.');
                        console.log(JSON.stringify(error));
                    });
                }
            },

            print: function () {
                const parentNodeOriginal = this.parentNode.original;
                const selectedNodeOriginal = this.selectedNode.original;

                $('#upperId').val(parentNodeOriginal ? parentNodeOriginal.id : '');
                $('#upperUrl').val(parentNodeOriginal ? parentNodeOriginal.url : '');
                $('#id').val(selectedNodeOriginal.id);
                $('#name').val(selectedNodeOriginal.name);
                $('#description').val(selectedNodeOriginal.description);
                adminCommon.toggleSwitch($('#isEnabled'), selectedNodeOriginal.isEnabled === 'Y');
                $(`input[name=type]:input[value=${selectedNodeOriginal.type}]`).prop('checked', true);
            },
        };

        $(function () {
            roleController.init();

            $('#saveBtn').on('click', function () {
                roleController.save();
            });
        });

    </script>
</div>
