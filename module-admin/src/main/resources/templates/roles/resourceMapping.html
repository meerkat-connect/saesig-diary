<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/web/thymeleaf/layout"
      layout:decorate="~{layout/main}">

<div layout:fragment="content" class="page-body">
  <div class="page-body">
    <div class="nav-main">
      <ul class="nav nav-tabs md-tabs" role="tablist">
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#home3" role="tab" aria-selected="false">역할 등록</a>
          <div class="slide"></div>
        </li>
        <li class="nav-item">
          <a class="nav-link" data-bs-toggle="tab" href="#profile3" role="tab" aria-selected="false">사용자 매핑</a>
          <div class="slide"></div>
        </li>
        <li class="nav-item">
          <a class="nav-link active" data-bs-toggle="tab" href="#messages3" role="tab" aria-selected="true">자원 매핑</a>
          <div class="slide"></div>
        </li>
      </ul>
    </div>
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-block-small">
            <div class="tab-content tabs p-t-20">
              <div class="tab-pane" id="home3" role="tabpanel">
              </div>
              <div class="tab-pane" id="profile3" role="tabpanel">
              </div>
              <div class="tab-pane" id="configMenu" role="tabpanel">
                <div id="configMenuContent"></div>
              </div>

              <div class="tab-pane active" id="messages3" role="tabpanel">
                <div class="col-12">
                  <div class="tab-content tabs">
                    <div class="tab-pane active" id="roleJudge" role="tabpanel">
                      <div class="row mb-3">
                        <div class="col-12 col-xl-4">
                          <h5 class="mb-3">
                            <strong>역할구조</strong>
                          </h5>
                          <div class="card">
                            <div class="card-block-small" id="jstree">
                            </div>
                          </div>
                        </div>
                        <div class="col-12 col-xl-8">
                          <div class="row">
                            <h5 class="col-12 col-md-6 mb-3">
                              <strong>자원구조</strong>
                            </h5>
                            <div class="col-12 col-md-6 btn-group-sm text-right">
                              <button type="button" id='resourceMappingSaveBtn' class="btn btn-primary btn-sm">저장</button>
                            </div>
                          </div>

                          <div class="card">
                            <div class="card-block-small" id="jstree2">
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="modal fade" id="memberListModalContainer" data-bs-backdrop="static" aria-hidden="true"></div>

  <link rel="stylesheet" type="text/css" th:href="@{/files/assets/pages/treeview/treeview.css}"></link>
  <link rel="stylesheet" type="text/css" th:href="@{/files/bower_components/jstree/dist/themes/default/style.css}"></link>
  <script type="text/javascript" src="/files/bower_components/jstree/dist/jstree.js"></script>

  <script th:inline="javascript">
    const roleController = {
      roles: [],
      $jstree: $('#jstree'),

      init: function () {
        const _this = this;

        $.ajax({
          url: '/admin/roles',
          type: 'get',
          async: false
        }).done(function (response) {
          response.forEach(function (element, index) {
            _this.roles[index] = {
              id: element.id,
              parent: element.parentId ?? '#',
              text: element.name,
              description: element.description,
              isEnabled: element.isEnabled,
              name: element.name,
            };
          });
        }).fail(function (error) {
          alert("역할 목록을 조회하는데 실패하였습니다.");
        });

        _this.renderJsTree();
      },

      renderJsTree: function () {
        const _this = this;

        _this.$jstree.jstree({
          "core": {
            "animation": 50,
            "strings": {
              loading: "Loading ..."
            },
            "themes": {
              "responsive": true,
            },
            'data': _this.roles,
            'check_callback': function(operation, node, node_parent, node_position, more) {
              if (operation === "move_node") {
                return false;
              }
            }
          },
          "types": {
            "default": {
              "icon": "icofont icofont-user-alt-3"
            }
          },
          'plugins': ['types']
        }).bind('move_node.jstree', function(evt, data) {
          console.log(data);
          if(data.rslt.ot != data.rslt.rt) {
            console.log("Node was moved to a different tree-instance");
          }
          else {
            console.log("Node was moved inside the same tree-instance");
          }
        });
      },
    };

    const resourceController = {
      resources: [],
      $jstree: $('#jstree2'),

      init: function () {
        const _this = this;

        $.ajax({
          url: '/admin/roles/mappedResources',
          type: 'get',
          async: false
        }).done(function (response) {
          response.forEach(function (element, index) {
            _this.resources[index] = {
              id: element.id,
              parent: element.parentId ? element.parentId : '#',
              text: element.name,
              type: element.type,
              httpMethod: element.httpMethod,
              url: element.url,
              isEnabled: element.isEnabled,
              name: element.name,
              depth: element.depth,
              ord: element.ord,
              state: {opened: true, selected: true}
            };
          });
        }).fail(function (error) {
          alert("자원 목록을 조회하는데 실패하였습니다.");
        });

        _this.renderJsTree();
      },

      renderJsTree: function () {
        const _this = this;

        _this.$jstree.jstree({
          "core": {
            "animation": 50,
            "strings": {
              loading: "Loading ..."
            },
            "themes": {
              "responsive": true,
            },
            'data': _this.resources,
            'check_callback' : true
          },
          "types": {
            "MENU": {
              "icon": "icofont icofont-folder"
            },
            "FUNCTION": {
              "icon": "icofont icofont-file-alt"
            }
          },
          'plugins': ['types','checkbox']
        }).bind("move_node.jstree", function (event, data) {
            console.log(data);
          if(data.rslt.ot != data.rslt.rt) {
            console.log("Node was moved to a different tree-instance");
          }
          else {
            console.log("Node was moved inside the same tree-instance");
          }
        }).bind('select_node.jstree', function(event,data){
          console.log('노드가 선택되었습니다:', data.node.text);
        }).bind('deselect_node.jstree', function(event,data){
          console.log('노드 선택이 해제되었습니다:', data.node.text);
        });
      },
    };

    $(function () {
      roleController.init();
      resourceController.init();

      $('#addMemberBtn').on('click',function() {
        if(!!roleController.selectedNode) {
          $("#memberListModalContainer").load('/admin/roles/memberListModal', function(response, status, xhr) {
            if (status == "success") {
              memberListModal = new bootstrap.Modal($('#memberListModalContainer'));
              memberListModal.show();
            }
          });
        } else{
          alert('역할을 선택하여 주십시오.');
        }
      })
    });

  </script>
</div>


