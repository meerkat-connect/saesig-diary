<!DOCTYPE html>
<html lang="en">
<!-- css from https://freefrontend.com/css-chats/ -->
<head>
    <meta charset="UTF-8">
    <title></title>
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css'>
    <link rel='stylesheet' href='https://fonts.googleapis.com/css?family=Montserrat'>
    <link rel='stylesheet'
          href='https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha.6/css/bootstrap.min.css'>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
<div class="container" style="width: 540px;">
    <section class="chat">

        <div id="chat" class="messages-chat" style="height: 620px;">
        </div>
        <div class="footer-chat">

            <input id="opinion" type="text" class="write-message" onkeyup="enterkey()"
                   placeholder="Type your message here">
            <i class="icon send fa fa-paper-plane-o clickable" onclick="sendMessage()" aria-hidden="true"></i>
        </div>
    </section>
</div>
</body>
<script src='https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js'></script>
<script type="text/javascript" src='/js/chattingRoom.js'></script>
<script th:inline="javascript">
    const currentMemberData = [[${currentMemberData}]];
    const targetMemberData = [[${targetMemberData}]]
    const chatLog = [[${chatDataLog}]]
    const chatId = [[${chatId}]];
    const username = currentMemberData[0]['nickname']
    const userid = currentMemberData[0]['id']

    const websocket = new WebSocket("ws://127.0.0.1:8080/ws/chat?chatId=" + chatId);
    websocket.onmessage = onMessage;
    websocket.onopen = onOpen;
    websocket.onclose = onClose;

    let isSeeing = true;
    document.addEventListener("visibilitychange", function () {
        console.log(document.visibilityState);
        if (document.visibilityState == "hidden") {
            isSeeing = false;
        } else {
            isSeeing = true;
        }
    });

    var newExcitingAlerts = (function () {
        var oldTitle = document.title;
        var msg = "â˜…Message!â˜…";
        var timeoutId;
        var blink = function () {
            document.title = document.title == msg ? ' ' : msg;
            if (isSeeing == true) {
                clear();
            }
        };
        var clear = function () {
            clearInterval(timeoutId);
            document.title = oldTitle;
            window.onmousemove = null;
            timeoutId = null;
        };
        return function () {
            if (!timeoutId) {
                timeoutId = setInterval(blink, 1000);
            }
        };
    }());

    setInterval(() => console.log(new Date()), 60000); //prevent chrome refresh

    $(document).ready(function () {
        $(".floating-chat").click();

        $("#disconn").on("click", (e) => {
            disconnect();
        })

        $("#button-send").on("click", (e) => {
            send();
        });
    })

    function setChatLog(){
        $(chatLog['chatDataDto']).each(function (){
            setMessageTemplate(this.sender_seq,this.text);
        })
    }

    function enterkey() {
        if (window.event.keyCode == 13) {
            if ($("#opinion").val() != "") {
                sendMessage($("#opinion").val());
                $("#opinion").val('');
            }
        }
    }

    function sendMessage(str) {
        if (str == '' || str == undefined){
            str = $("#opinion").val();
        }
        msg = {
            text : str,
            chatId : chatId,
            memberId : userid
        };

        websocket.send(JSON.stringify(msg));
    }

    function send() {
        if ($("#opinion").val() != "") {
            sendMessage($("#opinion").val());
            $("#opinion").val('');
        }
    }

    function onClose(evt) {
        var str = username + ": has left the room";
        sendMessage(str);
    }

    function onOpen(evt) {
        if (chatLog.chatDataDto.length == 0){
            var str = username + ": entered the room";
            sendMessage(str);
        }else{
            setChatLog();
        }
    }

    let cachedTime;
    let cachedSessionId;
    let isLastChatFromMe;

    function onMessage(msg) {
        console.log(msg)
        var data = JSON.parse(msg.data);
        var sessionId = data.memberId;
        var message = data.text;;

        var cur_session = userid;

        console.log("sessionID : " + sessionId);
        console.log("cur_session : " + cur_session);


        if (message == " entered the room") {
            message = sessionId + " entered the room ðŸ˜€";
        }

        cachedSessionId = sessionId;

        setMessageTemplate(sessionId,message)

        document.getElementById("chat").scrollTop = document.getElementById("chat").scrollHeight;
    }

    function setMessageTemplate(sessionId, message){
        const cur_session = userid;
        if (sessionId == cur_session) {
            var str = "<div class='message text-only'>";
            str += "<div class='response'><p class='text'>"
            str += message;
            str += "</p></div></div>";
            $("#chat").append(str);

            isLastChatFromMe = true;
        } else {
            if ($(document).find('.photo').length == 0) isLastChatFromMe = true
            if (isLastChatFromMe == true) {
                var str = "<div class='message'> <div class='photo you'><span>"+targetMemberData[0]['nickname']+"</span></div>";
                str += "<p class='text'>"
                str += message;
                str += "<p></div>";
                $("#chat").append(str);
            } else {
                var str = "<div class='message text-only'>";
                str += "<p class='text'>"
                str += message;
                str += "<p></div>";
                $("#chat").append(str);
            }
            isLastChatFromMe = false;

            if (isSeeing == false) {
                newExcitingAlerts();
            }
        }
    }

</script>
</html>
